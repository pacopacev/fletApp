name: Auto Bump Version and Deploy

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'src/.env'  # Ignore the actual .env file in src/

jobs:
  bump-version-and-deploy:
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'Bump version') }}
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create bump script for src/.env
      run: |
        cat > bump_version.py << 'EOF'
        import re
        from datetime import datetime
        import os

        env_path = 'src/.env'
        
        # Read from src/.env file
        try:
            with open(env_path, 'r') as f:
                content = f.read()
            
            # Look for APP_VERSION in .env file
            match = re.search(r'APP_VERSION=([0-9]+\.[0-9]+\.[0-9]+)', content)
            if match:
                current_version = match.group(1)
            else:
                current_version = "0.0.1"
                print("APP_VERSION not found in src/.env, using default")
        except FileNotFoundError:
            current_version = "0.0.1"
            print("src/.env file not found, using default version")

        print(f"Current version: {current_version}")

        # Bump patch version
        major, minor, patch = map(int, current_version.split('.'))
        patch += 1
        new_version = f"{major}.{minor}.{patch}"

        print(f"New version: {new_version}")

        # Read existing .env content
        env_lines = []
        try:
            with open(env_path, 'r') as f:
                env_lines = f.readlines()
        except FileNotFoundError:
            # Create basic template if .env doesn't exist
            env_lines = [
                "# Environment Variables\n",
                "DB_NAME=defaultdb\n",
                "DB_USER=avnadmin\n",
                "DB_PASSWORD=AVNS_IONeg4MWBUESkCApRE9\n",
                "DB_HOST=pa-pgdimitrov-bfdb.j.aivencloud.com\n",
                "DB_PORT=25464\n",
                "PORT=8553\n",
                "GITHUB_TOKEN=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\n",
                "APP_VERSION=0.0.1\n",
                "MAJOR=0\n",
                "MINOR=0\n",
                "PATCH=1\n",
                "BUILD_DATE=2024-06-10T12:00:00Z\n",
                "COMMIT_HASH=unknown\n",
                "KOYEB_API_KEY=f1t75mmsekfwc2q23b332hl8mx0ept37bsb9vehjpqchkk5sgk6h2u6h5zkckorl\n"
            ]
        
        # Update version-related variables
        build_date = datetime.now().strftime("%Y-%m-%dT%H:%M:%SZ")
        commit_hash = os.getenv("GITHUB_SHA", "")[:8]
        
        final_lines = []
        for line in env_lines:
            if line.startswith('APP_VERSION='):
                final_lines.append(f'APP_VERSION={new_version}\n')
            elif line.startswith('MAJOR='):
                final_lines.append(f'MAJOR={major}\n')
            elif line.startswith('MINOR='):
                final_lines.append(f'MINOR={minor}\n')
            elif line.startswith('PATCH='):
                final_lines.append(f'PATCH={patch}\n')
            elif line.startswith('BUILD_DATE='):
                final_lines.append(f'BUILD_DATE={build_date}\n')
            elif line.startswith('COMMIT_HASH='):
                final_lines.append(f'COMMIT_HASH={commit_hash}\n')
            else:
                final_lines.append(line)

        # Create src directory if it doesn't exist
        os.makedirs('src', exist_ok=True)
        
        # Write back to src/.env
        with open(env_path, 'w') as f:
            f.writelines(final_lines)

        print(f"Updated {env_path} with version {new_version}")
        print(f"::set-output name=new_version::{new_version}")
        print(f"::set-output name=build_date::{build_date}")
        print(f"::set-output name=commit_hash::{commit_hash}")
        EOF

    - name: Run bump script
      id: bump
      run: python bump_version.py
    
    - name: Update koyeb.yaml with new version
      run: |
        echo "Updating koyeb.yaml with new version: ${{ steps.bump.outputs.new_version }}"
        
        # Update koyeb.yaml with new version values
        sed -i "s/APP_VERSION: \".*\"/APP_VERSION: \"${{ steps.bump.outputs.new_version }}\"/" koyeb.yaml
        sed -i "s/MAJOR: \".*\"/MAJOR: \"0\"/" koyeb.yaml
        sed -i "s/MINOR: \".*\"/MINOR: \"0\"/" koyeb.yaml
        sed -i "s/PATCH: \".*\"/PATCH: \"${{ steps.bump.outputs.new_version.split('.')[2] }}\"/" koyeb.yaml
        sed -i "s/BUILD_DATE: \".*\"/BUILD_DATE: \"${{ steps.bump.outputs.build_date }}\"/" koyeb.yaml
        sed -i "s/COMMIT_HASH: \".*\"/COMMIT_HASH: \"${{ steps.bump.outputs.commit_hash }}\"/" koyeb.yaml
        
        echo "Updated koyeb.yaml:"
        cat koyeb.yaml
    
    - name: Commit and push version changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add src/.env koyeb.yaml
        git commit -m "Bump version to ${{ steps.bump.outputs.new_version }} [skip ci]"
        git push
    
    - name: Deploy to Koyeb using koyeb.yaml
      uses: koyeb-community/koyeb-actions@v2
      with:
        koyeb-token: ${{ secrets.KOYEB_TOKEN }}
        config: koyeb.yaml